# E2E Command

このCommandは、Playwright を使用してエンドツーエンド（E2E）テストの生成、保守、および実行を行う **e2e-runner** エージェントを呼び出します。

## このCommandの機能

1. **テストジャーニーの生成** - ユーザーフローに基づいた Playwright テストの作成
2. **E2E テストの実行** - 複数のブラウザ間でのテスト実行
3. **アーティファクトのキャプチャ** - 失敗時のスクリーンショット、ビデオ、トレース
4. **結果のアップロード** - HTML レポートおよび JUnit XML
5. **不安定なテストの特定** - 不安定（フレキー）なテストの切り分け

## 使用場面

以下の場合に `/e2e` を使用してください：

- クリティカルなユーザー旅程（ログイン、取引、決済）のテスト
- マルチステップのプロセスがエンドツーエンドで動作することの検証
- UI のインタラクションとナビゲーションのテスト
- フロントエンドとバックエンドの統合の検証
- 本番環境へのデプロイ準備

## 動作の仕組み

e2e-runner エージェントは以下の手順を実行します：

1. **ユーザーフローを分析**し、テストシナリオを特定します。
2. Page Object Model（POM）パターンを使用して **Playwright テストを生成**します。
3. **複数のブラウザ**（Chrome、Firefox、Safari）でテストを実行します。
4. **失敗時のスクリーンショット、ビデオ、トレース**をキャプチャします。
5. 結果とアーティファクトを含む **レポートを生成**します。
6. **不安定なテストを特定**し、修正案を提示します。

## テストアーティファクト

テスト実行時に以下のアーティファクトがキャプチャされます：

**すべてのテスト：**

- タイムラインと結果を含む HTML レポート
- CI 統合用の JUnit XML

**失敗時のみ：**

- 失敗した状態のスクリーンショット
- テストのビデオ録画
- デバッグ用のトレースファイル（ステップバイステップの再生）
- ネットワークログ
- コンソールログ

## アーティファクトの表示

```bash
# ブラウザで HTML レポートを表示
npx playwright show-report

# 特定のトレースファイルを表示
npx playwright show-trace artifacts/trace-abc123.zip

# スクリーンショットは artifacts/ ディレクトリに保存されます
open artifacts/search-results.png

```

## ベストプラクティス

**すべきこと：**

- ✅ 保守性のために Page Object Model を使用する
- ✅ セレクターとして `data-testid` 属性を使用する
- ✅ 任意のタイムアウトではなく、API レスポンスを待機する
- ✅ クリティカルなユーザージャーニーをエンドツーエンドでテストする
- ✅ メインブランチにマージする前にテストを実行する
- ✅ テスト失敗時にアーティファクトを確認する

**すべきでないこと：**

- ❌ 壊れやすいセレクター（変更される可能性のある CSS クラスなど）を使用する
- ❌ 実装の詳細をテストする
- ❌ 本番環境に対してテストを実行する
- ❌ 不安定なテストを無視する
- ❌ 失敗時のアーティファクト確認をスキップする
- ❌ E2E テストですべてのエッジケースをテストする（ユニットテストを使用する）

## クイックコマンド

```bash
# すべての E2E テストを実行
npx playwright test

# 特定のテストファイルを実行
npx playwright test tests/e2e/markets/search.spec.ts

# ヘッドレスモードを解除して実行（ブラウザを表示）
npx playwright test --headed

# テストをデバッグ
npx playwright test --debug

# テストコードを生成
npx playwright codegen http://localhost:3000

# レポートを表示
npx playwright show-report

```

## 他の指令との統合

- `/plan` を使用して、テストすべき重要なジャーニーを特定します。
- `/tdd` をユニットテストに使用します（より高速で細かい粒度）。
- `/e2e` を統合およびユーザージャーニーのテストに使用します。
- `/code-review` を使用してテストの品質を検証します。

## 関連エージェント

この指令は、以下にある `e2e-runner` エージェントを呼び出します：
`~/.claude/agents/e2e-runner.md`