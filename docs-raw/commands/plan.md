# Plan Command

このCommandは **planner** エージェントを呼び出し、コードを記述する前に包括的な実施計画を作成させます。

## このCommandの機能

1. **要件の再定義** - 何を構築する必要があるかを明確にします。
2. **リスクの特定** - 潜在的な問題や障害を明らかにします。
3. **段階的計画の作成** - 実装を複数のフェーズに分割します。
4. **承認待機** - 次に進む前に、必ずユーザーの承認を得る必要があります。

## 使用するタイミング

以下のような状況で `/plan` を使用してください：

- 新機能の開発を開始するとき
- 重大なアーキテクチャの変更を行うとき
- 複雑なリファクタリングを行うとき
- 複数のファイルやコンポーネントが影響を受けるとき
- 要件が不明確、または曖昧なとき

## 動作の仕組み

planner エージェントは以下の手順を踏みます：

1. **リクエストの分析**を行い、明確な言葉で要件を再定義します。
2. 具体的な実行ステップを含む**フェーズごとの分割**を行います。
3. コンポーネント間の関係から**依存関係の特定**を行います。
4. **リスクと潜在的な障害の評価**を行います。
5. **複雑度の見積もり**（高/中/低）を行います。
6. **計画を提示**し、ユーザーからの明示的な確認を待ちます。

## 使用例

```
ユーザー：/plan 市場の決済時にリアルタイム通知を追加したい。

Agent（planner）：
# 実施計画：リアルタイム市場決済通知

## 要件の再定義
- ユーザーがフォローしている市場が決済（解決）された際に通知を送信する
- 複数の通知チャネル（アプリ内、メール、Webhook）をサポートする
- 通知が確実に行われるようにする
- 市場の結果とユーザーのポジション結果を含める

## 実施フェーズ

### フェーズ 1：データベース・スキーマ
- notifications テーブルの追加：id, user_id, market_id, type, status, created_at
- 通知設定用の user_notification_preferences テーブルを追加
- パフォーマンス向上のため user_id と market_id にインデックスを作成

### フェーズ 2：通知サービス
- lib/notifications.ts に通知サービスを作成
- BullMQ/Redis を使用して通知キューを実装
- 送信失敗時のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ 3：統合ポイント
- 市場決済ロジックにフックを追加（ステータスが "resolved" に変わる際）
- その市場にポジションを持つ全ユーザーを照会
- 各ユーザーを通知キューに追加

### フェーズ 4：フロントエンド・コンポーネント
- ヘッダーに NotificationBell コンポーネントを作成
- 通知一覧のポップオーバー（NotificationList）を追加
- Supabase の Realtime 購読によるリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabase Realtime

## リスク
- 高：メールの到達率（SPF/DKIM の設定が必要）
- 中：1市場あたり 1,000人以上のユーザーがいる場合のパフォーマンス
- 中：頻繁に市場が決済される場合の通知スパム化
- 低：リアルタイム購読によるオーバーヘッド

## 推定複雑度：中
- バックエンド：4-6 時間
- フロントエンド：3-4 時間
- テスト：2-3 時間
- 合計：9-13 時間

**確認待ち**：この計画で進めてもよろしいですか？（はい / いいえ / 修正）

```

## 重要事項

**最重要**：あなたが「はい」「進めて」「OK」などの肯定的な返答で計画を明示的に承認するまで、planner エージェントは一切の**コードを記述しません**。

修正したい場合は、以下のように返信してください：

- 「修正：[変更内容]」
- 「別のアプローチ：[代替案]」
- 「フェーズ 2 をスキップして、先にフェーズ 3 をやって」

## 他のCommandとの連携

計画の承認後：

- テスト駆動開発で実装する場合は `/tdd` を使用
- ビルドエラーが発生した場合は `/build-fix` を使用
- 実装完了後は `/code-review` でレビュー

## 関連エージェント

このCommandは以下の場所にある `planner` エージェントを呼び出します：
`~/.claude/agents/planner.md`
